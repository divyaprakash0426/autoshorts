flowchart TD
  Start[Start - Input Video] --> AnalysisMode{GEMINI_DEEP_ANALYSIS?}
  
  %% Deep Analysis Path
  AnalysisMode -->|Yes| DeepAnalysis["üß† Deep Analysis Mode<br/>Gemini scans full video<br/>Finds highlight moments directly"]
  
  %% Heuristics Path
  AnalysisMode -->|No| Analysis[Video Analysis & Scene Extraction<br/>scenes + audio/video heuristics]
  Analysis --> HeuristicRank["Heuristic Scoring<br/>scene_action_score()"]
  HeuristicRank --> AIRank{AI_ANALYSIS_ENABLED?}
  AIRank -->|Yes| SemanticRank["AI Semantic Ranking<br/>rank_scenes_with_ai()"]
  AIRank -->|No| SelectScenes
  SemanticRank --> SelectScenes
  
  DeepAnalysis --> SelectScenes[Select Top Candidates<br/>Diverse category selection]
  
  %% Provider Decision
  SelectScenes --> Provider{AI_PROVIDER}
  Provider -->|local qwen3vl| LocalPregen["Local pre-gen<br/>captions & story narration<br/>Quantized 4B FP8 model"]
  Provider -->|remote openai/gemini| RemoteSkip["Remote provider<br/>on-demand captions"]
  LocalPregen --> Unload["Unload vision models<br/>free VRAM for TTS"]
  RemoteSkip --> Unload
  
  Unload --> Render[Render clips<br/>GPU NVENC encoding<br/>Random length within min/max bounds]
  Render --> SubToggle{ENABLE_SUBTITLES?}
  
  %% ========================================
  %% SUBTITLES ON (with Story Mode Fix)
  %% ========================================
  SubToggle -->|Yes| SubPipeline["generate_subtitles()"]
  SubPipeline --> SubtitleMode{SUBTITLE_MODE}
  SubtitleMode -->|speech| Whisper[Whisper transcribe -> SRT]
  SubtitleMode -->|ai_captions| AIGen[AI captions -> SRT]
  SubtitleMode -->|story_*| StoryNarration["generate_unified_story()<br/>AI creates narrative arc"]
  
  %% Story Mode - TTS First Flow (NEW!)
  StoryNarration --> TTSFirst{ENABLE_TTS?}
  TTSFirst -->|Yes| StoryTTSGen["üéôÔ∏è Generate TTS FIRST<br/>Qwen3-TTS VoiceDesign<br/>Measure actual audio durations"]
  TTSFirst -->|No| StoryWordEst["Word-count estimate<br/>for subtitle timing"]
  
  StoryTTSGen --> CheckDuration{"TTS > Video + 1s?"}
  CheckDuration -->|Yes| ExtendVideo["üìê Re-render Video BEFORE PyCaps<br/>Extend to TTS duration<br/>from source (render_meta)"]
  CheckDuration -->|No| UseOriginalVideo["Use original video<br/>for PyCaps"]
  
  ExtendVideo --> ApplyPyCaps
  UseOriginalVideo --> ApplyPyCaps
  StoryWordEst --> ApplyPyCaps
  
  Whisper --> ApplyPyCaps[apply_pycaps_subtitles<br/>PyCaps template rendering<br/>Output: .mp4]
  AIGen --> ApplyPyCaps
  
  %% PyCaps Detection Flow
  ApplyPyCaps --> PyCapsDetect["Detect PyCaps output<br/>Check: output_path, SRT-based _sub.mp4,<br/>video-based _sub.mp4"]
  PyCapsDetect --> PyCapsOK{Output found?}
  PyCapsOK -->|No| FFmpegFallback["FFmpeg subtitle burn-in<br/>(fallback mode)"]
  PyCapsOK -->|Yes| SubTTSDecision
  FFmpegFallback --> SubTTSDecision
  
  SubTTSDecision{Story TTS pre-generated?}
  SubTTSDecision -->|Yes| StoryMix["Mix pre-generated TTS<br/>No re-render needed<br/>(already extended)"]
  SubTTSDecision -->|No, captions| CaptionTTSGen["Generate TTS per caption<br/>with timing gaps"]
  SubTTSDecision -->|No TTS| SubOnly[Return subtitled clip]
  
  %% Normal TTS mixing (non-story)
  CaptionTTSGen --> CaptionDurCheck{TTS > clip?}
  CaptionDurCheck -->|Yes| CaptionTpad["tpad: freeze last frame<br/>extend video"]
  CaptionDurCheck -->|No| CaptionMix
  CaptionTpad --> CaptionMix
  
  %% Audio Mix
  StoryMix --> AudioMixCheck{"Video has audio?"}
  CaptionMix --> AudioMixCheck
  AudioMixCheck -->|Yes| MixWithGame["amix: blend game audio + TTS"]
  AudioMixCheck -->|No| AddTTSOnly["Add TTS as only audio track"]
  MixWithGame --> Final
  AddTTSOnly --> Final
  
  %% ========================================
  %% SUBTITLES OFF path
  %% ========================================
  SubToggle -->|No| TTSOnlyToggle{ENABLE_TTS?}
  TTSOnlyToggle -->|Yes| TTSOnly[TTS-only path]
  TTSOnly --> PregenCheck{Preloaded content?}
  PregenCheck -->|p_objects| UsePreg["Use pregenerated captions<br/>generate_for_captions"]
  PregenCheck -->|p_narration| StoryVoice["generate_story_voiceover<br/>Continuous narration"]
  PregenCheck -->|none & remote| OnDemand["generate_ai_captions<br/>-> generate_for_captions"]
  PregenCheck -->|none & no-ai| WhisperFB["Whisper transcribe<br/>-> generate_for_captions"]
  UsePreg --> ReRenderCheck
  StoryVoice --> ReRenderCheck
  OnDemand --> ReRenderCheck
  WhisperFB --> ReRenderCheck
  ReRenderCheck{TTS > clip + 1.5s?}
  ReRenderCheck -->|Yes| ReRender["Re-render clip longer<br/>from source video"]
  ReRenderCheck -->|No| TpadCheck{TTS > clip?}
  TpadCheck -->|Yes| Tpad["tpad: freeze last frame"]
  TpadCheck -->|No| Mix[Mix audio with video]
  ReRender --> Mix
  Tpad --> Mix
  
  TTSOnlyToggle -->|No| NoAudio[Return clip unchanged]
  Mix --> Final[Final clip: subtitled and/or voiced]
  SubOnly --> Final
  NoAudio --> Final
  
  %% Legend & Notes
  subgraph Legend["üéØ Key Updates"]
    direction LR
    L1["üìê Story Mode: TTS generated FIRST"]
    L2["üìê Video extended BEFORE PyCaps"]
    L3["üéôÔ∏è Subtitles rendered on full-length video"]
    L4["‚úÖ No subtitle loss during TTS mix"]
  end
  
  Final --> Legend
  
  %% Styling
  classDef newFlow fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
  classDef tts fill:#fff9c4,stroke:#f9a825
  classDef decision fill:#fff3e0,stroke:#e65100
  
  class StoryTTSGen,ExtendVideo,CheckDuration,UseOriginalVideo newFlow
  class QwenTTS,StoryMix,CaptionMix tts
